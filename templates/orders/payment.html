{% extends 'base.html' %}
{% load humanize %}
{% load i18n %}
{% load static %}
{% block title %}
Siciala/OrderConfirmation
{% endblock title %}

{% block body %}

    <!-- main content -->
    <div class="container bg-white" style='margin-top: 60px'>
        <div class="row">
            <div class="col-xl-12 mb-4">
                <div class="row">
                    <div class="col-lg-12 mb-3">
                        <div class="card p-lg-5 p-4 bg-primary-gradiant rounded-3 shadow-xss bg-pattern border-0 overflow-hidden">
                            <div class="bg-pattern-div"></div>
                            <h2 class="display2-size display2-md-size fw-700 text-white mb-0 mt-0">Order Confirmation</h2>
                        </div>
                    </div>                                 
                </div>

                <div class="row">
                    <div class="col-xl-5 col-lg-6">
                        <h4 class="mont-font fw-600 font-md mb-lg-5 mb-5">Shipping address</h4>
                        <div class="page-title mb-2">
                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">First Name</label>
                                        <input class="form-control" type="text" disabled value='{{order.shipping_address.first_name}}'>
                                    </div>        
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Last Name</label>
                                        <input class="form-control" type="text" disabled value='{{order.shipping_address.last_name}}'>
                                    </div>        
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Email</label>
                                        <input class="form-control" type="email" disabled value='{{order.shipping_address.email}}'>
                                    </div>        
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Phone</label>
                                        <input class="form-control" type="tel" disabled value='{{order.shipping_address.phone}}'>
                                    </div>        
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-12 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Address1</label>
                                        <input class="form-control" type="text" disabled value='{{order.shipping_address.address1}}'>
                                    </div>        
                                </div>

                                <div class="col-lg-12 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Address2</label>
                                        <input class="form-control" type="text" disabled value='{{order.shipping_address.address2}}'>
                                    </div>        
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Twon / City</label>
                                        <input class="form-control" type="text" disabled value='{{order.shipping_address.city}}'>
                                    </div>        
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Postcode</label>
                                        <input class="form-control" type="text" disabled value='{{order.shipping_address.zip_code}}'>
                                    </div>        
                                </div>
                            </div>
                        </div>

                        <h4 class="mont-font fw-600 font-md mb-lg-5 mb-5">Billing address</h4>
                        <div class="page-title">
                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">First Name</label>
                                        <input class="form-control" type="text" disabled value='{{order.billing_address.first_name}}'>
                                    </div>        
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Last Name</label>
                                        <input class="form-control" type="text" disabled value='{{order.billing_address.last_name}}'>
                                    </div>        
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Email</label>
                                        <input class="form-control" type="email" disabled value='{{order.billing_address.email}}'>
                                    </div>        
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Phone</label>
                                        <input class="form-control" type="tel" disabled value='{{order.billing_address.phone}}'>
                                    </div>        
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-12 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Address1</label>
                                        <input class="form-control" type="text" disabled value='{{order.billing_address.address1}}'>
                                    </div>        
                                </div>

                                <div class="col-lg-12 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Address2</label>
                                        <input class="form-control" type="text" disabled value='{{order.billing_address.address2}}'>
                                    </div>        
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Twon / City</label>
                                        <input class="form-control" type="text" disabled value='{{order.billing_address.city}}'>
                                    </div>        
                                </div>

                                <div class="col-lg-6 mb-3">
                                    <div class="form-gorup">
                                        <label class="mont-font fw-600 font-xssss">Postcode</label>
                                        <input class="form-control" type="text" disabled value='{{order.billing_address.zip_code}}'>
                                    </div>        
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side -->
                    <div class="col-xl-6 offset-xl-1 col-lg-6">
                        <div class="order-details">
                            <h4 class="mont-font fw-600 font-md mb-5">{% trans 'Order Details' %}</h4>
                            <div class="table-content table-responsive mb-5 card border-0 bg-greyblue p-lg-5 p-4">
                            <table class="table order-table order-table-2 mb-0">
                                <thead>
                                    <tr>
                                        <th class="border-0">{% trans 'Product' %}</th>
                                        <th class="border-0">{% trans 'Color' %}</th>
                                        <th class="border-0">{% trans 'Size' %}</th>
                                        <th class="border-0">{% trans 'Total' %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for i in order_items %}
                                    <tr>
                                        <td class="text-grey-500 fw-500 font-xsss">
                                            <img src="{{i.product.img.url}}" style='max-width:25px; max-height: 25px' alt="ProductImg">
                                            {{ i.product.name }}
                                            <strong><span>x</span>{{ i.quantity }}</strong>
                                        </td>
                                        <td class="text-grey-500 fw-500 font-xsss">
                                            {% if i.color.value %}
                                                <p class="btn-round-sm d-inline-block" style="background-color: {{ i.color.value }}; width: 25px; height: 25px;" title="{{ i.color.value }}"></p>
                                            {% else %}
                                                <p class="text-muted ms-3">-</p>
                                            {% endif %}
                                        </td>
                                        <td class="text-grey-500 fw-500 font-xsss">{{ i.size.value|default:"-" }}</td>
                                        <td class="text-grey-500 fw-500 font-xsss">${{ i.get_product_price|intcomma }}</td>
                                        
                                        {% if i.product.stock == 0 %}
                                            <td class="product-remove text-right">
                                                <a href="{% url 'delete_from_order' payment_option order.order_number %}" class="remove-item" data-cartitem-id="{{ i.product.pk }}">
                                                    <i class="ti-trash font-xs text-danger"></i>
                                                </a>
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}

                                </tbody>
                                <tfoot>
                                    
                                    {% if request.session.applied_coupon %}
                                    <tr class="order-total">
                                        <th>{% trans 'Coupon' %}</th>
                                        <td colspan='3' class="text-right text-grey-700 font-xsss fw-700"><span class="order-total-ammount">${{ request.session.applied_coupon.amount|intcomma }}</span></td>
                                    </tr>
                                    {% endif %}

                                    <tr class="order-total">
                                        <th>{% trans 'Order Total' %}</th>
                                        <td colspan='3' class="text-right text-grey-700 font-xsss fw-700"><span class="order-total-ammount">${{order.total|intcomma}}</span></td>
                                    </tr>

                                    <tr class="order-total">
                                        <th>{% trans 'Payment Method' %}</th>
                                        <td colspan='3' class="text-right text-success font-xsss fw-700"><span class="order-total-ammount">{{ payment_option }}</span></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="checkout-payment card border-0 mb-3 bg-greyblue p-lg-4">
                            {% if payment_option == 'Stripe' %}
                                <script src="https://js.stripe.com/v3/"></script>
                                <button id="checkout-button" type="submit" class="btn w-100 p-3 mt-3 font-xsss text-center text-white bg-current rounded-3 fw-600 ls-3">{% trans 'Buy Now' %} ${{ order.total }}</button>    
                                <div class="mt-3 text-center">
                                    <small class="text-muted">Secure payment powered by Stripe</small>
                                </div>
                            {% elif payment_option == 'PayPal' %}
                                <div id="paypal-button-container"></div>
                                <div id="loading" style="display: none; text-align: center; padding: 20px;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Processing payment...</p>
                                </div>
                            {% elif payment_option == 'CashOnDelivery' %}
                                <form method="POST">
                                    {% csrf_token %}
                                    <button type="submit" class="btn w-100 p-3 mt-3 font-xsss text-center text-white bg-current rounded-3 fw-600 ls-3">{% trans 'Buy Now' %} ${{ order.total }}</button>    
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>               
        </div>
    </div>
    <!-- main content -->
    
{% endblock body %}

{% block script %}
    {% if payment_option == "Stripe" %}
        <script type="text/javascript">
            var stripe = Stripe('{{ stripe_public_key }}');  
        
            const lang = window.location.pathname.split("/")[1]; 
            
            function createCheckoutSession() {
                fetch(`/${lang}/orders/create_checkout_session/{{order.order_number}}/`, {
                    method: 'POST',
                })
                .then(function (response) {
                    return response.json();
                })
                .then(function (sessionId) {
                    return stripe.redirectToCheckout({ sessionId: sessionId.id });
                })
                .then(function (result) {
                    if (result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                    alert("An error occurred while processing the payment.");
                });
            }
        
            // Add event listener to the button
            document.getElementById("checkout-button").addEventListener("click", function(e) {
                e.preventDefault();
                createCheckoutSession();
            });
        </script>
    {% elif payment_option == 'PayPal' %}
        <script src="https://www.paypal.com/sdk/js?client-id={{paypal_client_id}}&currency=USD&disable-funding=paylater,venmo"></script>
        <script>
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            reference_id: "{{ order.order_number }}",
                            description: "Order #{{ order.order_number }}",
                            amount: {
                                currency_code: "USD",
                                value: "{{ order.total }}",
                                breakdown: {
                                    item_total: {
                                        currency_code: "USD",
                                        value: "{{ order.total }}"
                                    }
                                }
                            },
                            items: [
                                {% for item in order.items.all %}
                                {
                                    name: "{{ item.product.name|slice:':127'|escapejs }}",
                                    unit_amount: {
                                        currency_code: "USD",
                                        value: "{{ item.product_price }}"
                                    },
                                    quantity: "{{ item.quantity }}"
                                }{% if not forloop.last %},{% endif %}
                                {% endfor %}
                            ]
                        }],
                        application_context: {
                            brand_name: "SocialaStore",
                            landing_page: "BILLING",
                            user_action: "PAY_NOW"
                        }
                    });
                },
                
                onApprove: async function(data, actions) {
                    try {
                        document.getElementById('paypal-button-container').style.display = 'none';
                        document.getElementById('loading').style.display = 'block';
                        
                        const orderData = await actions.order.capture();
                        
                        const response = await fetch("{% url 'paypal_capture_order' order.order_number %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                orderID: data.orderID,
                                orderData: orderData
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            window.location.href = "{% url 'success' order.order_number %}";
                        } else {
                            throw new Error(result.message || 'Payment processing failed');
                        }
                    } catch (error) {
                        console.error('Payment error:', error);
                        alert('Payment failed: ' + error.message);
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('paypal-button-container').style.display = 'block';
                    }
                },
                
                onError: function(err) {
                    console.error('PayPal Error:', err);
                    alert('An error occurred during payment processing. Please try again.');
                },
                
                onCancel: function(data) {
                    console.log('Payment cancelled by user');
                },
                
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'pill',
                    label: 'paypal',
                    height: 45
                }
            }).render('#paypal-button-container');
        </script>
    {% endif %}

    <script>

        const useDefaultShippingRadios = document.querySelectorAll('[name="use_default_shipping"]');
        const ShippingFieldscardElementContainer = document.getElementById("shiping-content");
        
        const SameShippingCheckbox = document.getElementById("same_shipping_address");
        const useDefaultbillingCheckbox = document.querySelectorAll("[name='use_default_billing']");
        const billingfiledsElementContainer = document.getElementById("billing-address");

        useDefaultShippingRadios.forEach((radio) => {
            radio.addEventListener("change", (event) => {
                if (event.target.checked) {
                    // Hide Card Element when using default shipping
                    ShippingFieldscardElementContainer.style.display = "none";
                } else {
                    // Show Card Element when not using default shipping
                    ShippingFieldscardElementContainer.style.display = "block";
                }
            });
        });

        useDefaultbillingCheckbox.forEach((radio) => {
            radio.addEventListener("change", (event) => {
                if (event.target.checked) {
                    // Hide Card Element when using default card
                    billingfiledsElementContainer.style.display = "none";
                } else {
                    // Show Card Element when not using default card
                    billingfiledsElementContainer.style.display = "block";
                }
            });
        });

        document.querySelectorAll('[name="use_default_shipping"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const shippingFields = document.querySelectorAll('[name="shipping_first_name"],[name="shipping_last_name"],[name="shipping_email"],[name="shipping_phone"],[name="shipping_address1"],[name="shipping_address2"],[name="shipping_city"],[name="shipping_zip"],[name="set_default_shipping"],[name="same_shipping_address"]');
                shippingFields.forEach(field => field.disabled = this.checked);
            });
        });

        document.querySelectorAll('[name="use_default_billing"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const billingFields = document.querySelectorAll('[name="same_shipping_address"], [name="set_default_billing"],[name="billing_first_name"],[name="billing_last_name"],[name="billing_email"],[name="billing_phone"],[name="billing_address1"],[name="billing_address2"],[name="billing_city"],[name="billing_zip"]');
                billingFields.forEach(field => field.disabled = this.checked);
            });
        });
        
        document.getElementById('same_shipping_address').addEventListener('change', function(){
            if (this.checked) {
                document.querySelector('[name="billing_first_name"]').value = document.querySelector('[name="shipping_first_name"]').value; 
                document.querySelector('[name="billing_last_name"]').value = document.querySelector('[name="shipping_last_name"]').value;
                document.querySelector('[name="billing_email"]').value = document.querySelector('[name="shipping_email"]').value;
                document.querySelector('[name="billing_phone"]').value = document.querySelector('[name="shipping_phone"]').value;
                document.querySelector('[name="billing_address1"] ').value = document.querySelector('[name="shipping_address1"]').value;
                document.querySelector('[name="billing_address2"]').value = document.querySelector('[name="shipping_address2"]').value;
                document.querySelector('[name="billing_city"]').value = document.querySelector('[name="shipping_city"]').value;
                document.querySelector('[name="billing_zip"]').value = document.querySelector('[name="shipping_zip"]').value;
            }
        });

    </script>
{% endblock script %}